<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Course - Interactive Demo with Notes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Variables --- */
        :root {
            --primary-color: #02AFB1;
            --primary-color-light: rgba(2, 175, 177, 0.1);
            --primary-color-hover: rgba(2, 175, 177, 0.8);
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --background-light-grey: #F4F6FA;
            --border-color: #EAECEF;
            --font-color-primary: #343640;
            --font-color-secondary: #555;
            --white: #FFFFFF;
            --shadow: 0px 4px 15px rgba(0, 0, 0, 0.08);
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light-grey);
            color: var(--font-color-primary);
            height: 100vh;
            user-select: none;
            /* Added padding and box-sizing to create space around the main container */
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- Main Layout --- */
        .lesson-container {
            display: flex;
            flex-direction: column;
            /* Changed height to 100% to fit within the padded body */
            height: 100%;
            /* Added border-radius, overflow, and shadow for a focused, card-like appearance */
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 25px;
            background-color: var(--white);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .lesson-header .course-title { font-size: 18px; font-weight: 600; }
        .lesson-header .user-info { display: flex; align-items: center; gap: 20px; }
        .user-info .points { font-weight: 500; color: var(--primary-color); font-size: 14px; }
        .user-info .avatar { width: 36px; height: 36px; background-color: var(--primary-color-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary-color); }

        .lesson-body {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            background-color: var(--white); /* Ensure body background is white */
        }

        .left-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .video-section {
            flex: 1; /* Changed for 50/50 split */
            min-height: 150px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .video-placeholder {
            width: 100%;
            height: 100%;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            transition: filter 0.3s;
        }
        #video-controls {
            position: absolute;
            bottom: 15px;
            left: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #video-timeline {
             display: flex;
             align-items: center;
             gap: 15px;
        }
        #play-pause-btn {
            background: none; border: none; color: white; cursor: pointer; padding: 0;
        }
        #video-time-display {
            font-size: 14px;
            font-variant-numeric: tabular-nums;
        }
        #progress-bar-container {
            width: 100%;
            height: 4px;
            background-color: rgba(255,255,255,0.3);
            border-radius: 2px;
            cursor: pointer;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 2px;
        }
        
        .video-overlay-button {
            position: absolute;
            width: 44px;
            height: 44px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .video-overlay-button:hover { background-color: rgba(0, 0, 0, 0.7); }
        .video-overlay-button svg { color: white; width: 22px; height: 22px; }

        #save-note-btn { top: 15px; right: 15px; }
        #ai-assist-btn { bottom: 15px; right: 15px; }
        
        .chat-body { flex-grow: 1; padding: 15px; overflow-y: auto; font-size: 14px; line-height: 1.5; display: flex; flex-direction: column; }
        .chat-msg { padding: 8px 12px; border-radius: 10px; margin-bottom: 10px; max-width: 85%; line-break: anywhere; }
        .ai-msg { background-color: var(--background-light-grey); align-self: flex-start; }
        .user-msg { background-color: var(--primary-color-light); align-self: flex-end; }
        .loading-msg { color: #888; font-style: italic; align-self: flex-start; }
        .chat-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: #fcfcfc; }
        .chat-input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .chat-input-area input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }
        .chat-input-area button {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .chat-input-area button:hover {
            background-color: var(--primary-color-hover);
        }

        .disclaimer {
            font-size: 11px;
            color: #999;
            text-align: center;
            padding: 10px 0 0;
            line-height: 1.4;
        }

        .interactive-section {
            flex: 1; /* Changed for 50/50 split */
            min-height: 200px;
            background-color: var(--white);
            display: flex;
            flex-direction: column;
        }
        
        .interactive-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .interactive-tab-button { flex: 1; padding: 15px; font-size: 15px; font-weight: 500; text-align: center; cursor: pointer; border: none; background: none; color: var(--font-color-secondary); border-bottom: 3px solid transparent; transition: all 0.2s ease; }
        .interactive-tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .interactive-tab-content { flex-grow: 1; overflow: hidden; position: relative; }
        .interactive-tab-pane { display: none; height: 100%; overflow-y: auto; padding: 25px; box-sizing: border-box; }
        .interactive-tab-pane.active { display: block; }
        
        .question-number { font-size: 14px; font-weight: 600; color: var(--primary-color); margin-bottom: 15px; }
        .question-text { font-size: 18px; line-height: 1.6; margin-bottom: 25px; }
        .answer-options { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .option-btn { display: flex; align-items: center; width: 100%; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--white); cursor: pointer; text-align: left; font-size: 16px; font-family: 'Inter', sans-serif; transition: all 0.2s ease; }
        .option-btn:hover { border-color: var(--primary-color); background-color: var(--primary-color-light); }
        .option-btn .option-label { display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; border: 1px solid var(--border-color); border-radius: 50%; margin-right: 15px; font-weight: 600; flex-shrink: 0; }
        .option-btn:hover .option-label { border-color: var(--primary-color); color: var(--primary-color); }
        .option-btn.correct { background-color: #e9fbf0; border-color: var(--correct-color); color: var(--correct-color); cursor: not-allowed; }
        .option-btn.correct .option-label { background-color: var(--correct-color); border-color: var(--correct-color); color: var(--white); }
        .option-btn.incorrect { background-color: #fceeee; border-color: var(--incorrect-color); color: var(--incorrect-color); cursor: not-allowed; }
        .option-btn.incorrect .option-label { background-color: var(--incorrect-color); border-color: var(--incorrect-color); color: var(--white); }
        .option-btn.disabled { cursor: not-allowed; opacity: 0.7; }
        
        .explanation { margin-top: 30px; padding: 20px; background-color: #f7f7f9; border-radius: 8px; border: 1px solid #e1e1e6; }
        .explanation h3 { font-size: 16px; color: var(--font-color-primary); margin-top: 0; margin-bottom: 10px; }
        .explanation-steps { font-size: 15px; line-height: 1.7; color: var(--font-color-secondary); margin: 0; }
        .explanation-steps p { margin-bottom: 1em; }
        
        #ai-guidance-container { display: none; }
        #ai-guidance-chat { max-height: 200px; overflow-y: auto; margin-bottom: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; }
        #ai-guidance-chat .chat-msg { font-size: 14px; }
        #guidance-input-area { display: flex; gap: 10px; }
        #guidance-input { flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; }
        #show-answer-btn { background-color: var(--primary-color); color: white; border: none; border-radius: 6px; padding: 8px 15px; font-size: 14px; cursor: pointer; transition: background-color 0.2s; }
        #show-answer-btn:hover { background-color: var(--primary-color-hover); }
        #static-explanation-container { display: none; }
        #next-step-btn { background-color: var(--primary-color); color: white; border: none; border-radius: 6px; padding: 8px 15px; font-size: 14px; cursor: pointer; margin-top: 15px; transition: background-color 0.2s; }
        #next-step-btn:hover { background-color: var(--primary-color-hover); }
        #next-step-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .tool-pane { padding: 0; height: 100%; }
        .tool-pane iframe { 
            width: 125%; 
            height: 125%; 
            border: none;
            transform: scale(0.8);
            transform-origin: 0 0;
        }
        .transcription-pane .content { padding: 25px; font-size: 15px; line-height: 1.8; color: var(--font-color-secondary); }
        .transcription-pane .content span { display: inline-block; margin-right: 5px; }
        .transcription-pane .content span.current { background-color: var(--primary-color-light); color: var(--primary-color); font-weight: 600; padding: 2px 5px; border-radius: 4px;}

        .auxiliary-section {
            flex: 1; /* Changed for 50/50 split */
            min-width: 250px;
            background-color: var(--white);
            display: flex;
            flex-direction: column;
        }
        .auxiliary-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .auxiliary-tab-button { flex: 1; padding: 15px; font-size: 15px; font-weight: 500; text-align: center; cursor: pointer; border: none; background: none; color: var(--font-color-secondary); border-bottom: 3px solid transparent; transition: all 0.2s ease; }
        .auxiliary-tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .auxiliary-tab-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column;}
        .auxiliary-tab-pane { display: none; flex-grow: 1; padding: 0; box-sizing: border-box;}
        .auxiliary-tab-pane.active { display: flex; flex-direction: column; }
        .course-outline { padding: 20px; }
        .course-outline ul { list-style: none; padding: 0; margin: 0; }
        .course-outline li { padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-size: 15px; display: flex; align-items: center; gap: 10px; }
        .course-outline li.completed::before { content: '✔'; color: var(--correct-color); }
        .course-outline li.current { font-weight: 600; color: var(--primary-color); }
        .course-outline li.current::before { content: '▶'; color: var(--primary-color); }
        
        /* --- Note Styles --- */
        .note-entry {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .note-entry.manual-note {
            display: block; /* Revert for manual notes */
        }
        .note-thumbnail {
            flex-shrink: 0;
            width: 100px;
            height: 65px;
            background-color: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            border: 1px solid #444;
        }
        .note-content {
            flex-grow: 1;
        }
        .note-timestamp {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 8px;
        }
        .note-body, .note-transcript-quote {
            color: var(--font-color-secondary);
            line-height: 1.7;
            font-size: 15px;
            outline: none;
        }
        .conversation-entry {
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .conversation-timestamp {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 8px;
        }
        .conversation-body {
            color: var(--font-color-secondary);
            line-height: 1.7;
            font-size: 15px;
            outline: none;
        }
        .conversation-context {
            font-size: 13px;
            font-style: italic;
            color: #888;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .conversation-body .chat-msg { font-size: 14px; }
        #notes-list-container {
             flex-grow: 1;
             overflow-y: auto;
             padding: 20px;
        }
        
        #conversations.auxiliary-tab-pane, #notes.auxiliary-tab-pane {
            padding: 0;
        }
        #conversation-chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .resizer {
            background-color: var(--border-color);
            z-index: 500;
        }
        .resizer-v {
            width: 5px;
            cursor: col-resize;
            height: 100%;
        }
        .resizer-h {
            height: 5px;
            cursor: row-resize;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="lesson-container">
        <header class="lesson-header">
            <div class="course-title">AMC 10 Geometry Sprint - Similar Triangles</div>
            <div class="user-info">
                <span class="points">Points: 1200</span>
                <div class="avatar">U</div>
            </div>
        </header>

        <main class="lesson-body">
            <div class="left-container" id="left-container">
                <section class="video-section" id="video-section">
                    <div class="video-placeholder" id="video-placeholder">
                        <div id="video-content">Teacher's Video Area</div>
                        <div id="video-controls">
                            <div id="progress-bar-container">
                                <div id="progress-bar"></div>
                            </div>
                            <div id="video-timeline">
                                <button id="play-pause-btn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 5V19L19 12L8 5Z"/></svg>
                                </button>
                                <span id="video-time-display">00:00 / 01:30</span>
                            </div>
                        </div>
                        <button id="save-note-btn" class="video-overlay-button" title="Save keyframe and transcript to notes">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>
                        </button>
                        <button id="ai-assist-btn" class="video-overlay-button" title="Call AI Assistant">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V7.5a2.25 2.25 0 00-2.25-2.25H7.5A2.25 2.25 0 005.25 7.5v10.5a2.25 2.25 0 002.25 2.25z" /></svg>
                        </button>
                    </div>
                </section>

                <div class="resizer resizer-h" id="resizer-h"></div>

                <section class="interactive-section" id="interactive-section">
                    <div class="interactive-tabs">
                        <button class="interactive-tab-button" onclick="openInteractiveTab(event, 'transcript')">Transcript</button>
                        <button class="interactive-tab-button active" onclick="openInteractiveTab(event, 'outline')">Course Outline</button>
                        <button class="interactive-tab-button" onclick="openInteractiveTab(event, 'quiz')">In-Class Quiz</button>
                    </div>
                    <div class="interactive-tab-content">
                        <div id="quiz" class="interactive-tab-pane">
                            <div class="question-number">In-Class Quiz 1</div>
                            <p class="question-text" id="question-text">In triangle ABC, D is a point on AB and E is a point on AC, such that DE || BC. If AD = 3, DB = 5, and AE = 4, what is the length of EC?</p>
                            <div id="answer-options" class="answer-options">
                                <button class="option-btn" data-option="A"><span class="option-label">A</span><span class="option-text">5</span></button>
                                <button class="option-btn" data-option="B" data-correct="true"><span class="option-label">B</span><span class="option-text">20/3</span></button>
                                <button class="option-btn" data-option="C"><span class="option-label">C</span><span class="option-text">6</span></button>
                                <button class="option-btn" data-option="D"><span class="option-label">D</span><span class="option-text">7</span></button>
                            </div>
                            <div id="explanation" class="explanation" style="display: none;">
                                <h3>Solution Explanation</h3>
                                <div id="ai-guidance-container">
                                    <div id="ai-guidance-chat" class="chat-body"></div>
                                    <div id="guidance-input-area">
                                        <input type="text" id="guidance-input" placeholder="Enter your thoughts...">
                                        <button id="show-answer-btn">Show Full Answer</button>
                                    </div>
                                </div>
                                <div id="static-explanation-container">
                                    <div class="explanation-steps" id="explanation-steps"></div>
                                    <button id="next-step-btn">Next Step</button>
                                </div>
                            </div>
                        </div>
                        <div id="outline" class="interactive-tab-pane course-outline active">
                            <ul>
                                <li class="completed">1. Definition of Similar Triangles</li>
                                <li class="completed">2. AA, SAS, SSS Similarity</li>
                                <li class="current">3. Triangle Proportionality Theorem</li>
                                <li>4. Area Ratio and Similarity Ratio</li>
                                <li>5. Comprehensive Examples</li>
                            </ul>
                        </div>
                        <div id="transcript" class="interactive-tab-pane transcription-pane">
                            <div class="content">
                                <p><span data-time="1">(00:01)</span><span>Hello everyone,</span><span> and welcome to today's lesson.</span></p>
                                <p><span data-time="5" class="current">(00:05)</span><span>Today we're going to learn about a key property of similar triangles:</span><span> the Triangle Proportionality Theorem.</span></p>
                                <p><span data-time="15">(00:15)</span><span>Let's look at a specific example.</span><span> In triangle ABC...</span></p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="resizer resizer-v" id="resizer-v"></div>

            <aside class="auxiliary-section" id="auxiliary-section">
                <div class="auxiliary-tabs">
                    <button class="auxiliary-tab-button active" onclick="openAuxiliaryTab(event, 'tool')">Interactive Tool</button>
                    <button class="auxiliary-tab-button" onclick="openAuxiliaryTab(event, 'notes')">My Notes</button>
                    <button class="auxiliary-tab-button" onclick="openAuxiliaryTab(event, 'conversations')">AI Conversations</button>
                </div>
                <div class="auxiliary-tab-content">
                    <div id="tool" class="auxiliary-tab-pane tool-pane active">
                        <iframe src="https://www.desmos.com/calculator?lang=en"></iframe>
                    </div>
                    <div id="notes" class="auxiliary-tab-pane">
                        <div id="notes-list-container">
                             <div class="note-entry">
                                <div class="note-thumbnail">Keyframe</div>
                                <div class="note-content">
                                    <span class="note-timestamp">Video Time: 00:05</span>
                                    <div class="note-transcript-quote" contenteditable="true">"Today we're going to learn about a key property of similar triangles: the Triangle Proportionality Theorem."</div>
                                </div>
                            </div>
                        </div>
                        <div class="chat-footer">
                            <div class="chat-input-area">
                                <input type="text" id="note-input" placeholder="Enter your new note...">
                                <button id="submit-note-btn">Submit</button>
                            </div>
                        </div>
                    </div>
                    <div id="conversations" class="auxiliary-tab-pane">
                        <div id="conversation-chat-container">
                            <div class="chat-body" id="conversation-chat-body">
                                <!-- Initial AI message will be added here via JS -->
                            </div>
                            <div class="chat-footer">
                                <div class="chat-input-area">
                                    <input type="text" id="conversation-chat-input" placeholder="Type your question...">
                                    <button id="send-conversation-btn">Submit</button>
                                </div>
                                <div class="disclaimer">
                                    The Tutor is powered by AI, so check for mistakes and don't share sensitive info. Your data will be used in accordance with PDA's Privacy Notice.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // Mock Gemini API call
        const callGeminiApi = async (prompt) => {
            console.log("Calling Mock API with prompt:", prompt);
            // In a real scenario, this would be a fetch call.
            // Here, we simulate a delay and provide a mock response.
            return new Promise(resolve => {
                setTimeout(() => {
                    if (prompt.includes("Socratic method")) {
                        resolve("That's an interesting choice. Can you tell me what you know about parallel lines inside a triangle? What do they create?");
                    } else if (prompt.includes("latest reply")) {
                        resolve("Good thinking. What does it mean for two triangles to be similar in terms of their sides?");
                    } else {
                        resolve("I am a helpful AI Math Assistant. Based on the theorem of triangle proportionality, since DE is parallel to BC, the ratio of the sides is proportional. You can set up the equation AD/DB = AE/EC to find the answer.");
                    }
                }, 1000);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- Mock video object and timeline ---
            const video = {
                currentTime: 5,
                duration: 90,
                paused: true,
                interval: null,
                topics: [
                    { time: 0, name: "Introduction" },
                    { time: 5, name: "Triangle Proportionality Theorem" },
                    { time: 25, name: "Area Ratio and Similarity Ratio" }
                ],
                getCurrentTopic: function() {
                    let currentTopic = this.topics[0].name;
                    for (const topic of this.topics) {
                        if (this.currentTime >= topic.time) {
                            currentTopic = topic.name;
                        } else {
                            break;
                        }
                    }
                    return currentTopic;
                },
                play: function() {
                    if (this.paused) {
                        this.paused = false;
                        playPauseBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M6 19H10V5H6V19ZM14 5V19H18V5H14Z"/></svg>`;
                        this.interval = setInterval(updateVideoTime, 1000);
                    }
                },
                pause: function() {
                    if (!this.paused) {
                        this.paused = true;
                        playPauseBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 5V19L19 12L8 5Z"/></svg>`;
                        clearInterval(this.interval);
                    }
                }
            };
            
            const timeDisplay = document.getElementById('video-time-display');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const progressBar = document.getElementById('progress-bar');
            const transcriptContent = document.querySelector('.transcription-pane .content');

            function formatTime(seconds) {
                const min = Math.floor(seconds / 60).toString().padStart(2, '0');
                const sec = (seconds % 60).toString().padStart(2, '0');
                return `${min}:${sec}`;
            }

            function updateVideoTime() {
                if (video.currentTime >= video.duration) {
                    video.pause();
                    video.currentTime = 0;
                } else {
                    video.currentTime++;
                }

                const progressPercent = (video.currentTime / video.duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
                
                // Update transcript highlighting
                const allSpans = transcriptContent.querySelectorAll('p span[data-time]');
                let currentSpan = allSpans[0];
                for(const span of allSpans) {
                    if (video.currentTime >= parseInt(span.dataset.time)) {
                        currentSpan = span;
                    } else {
                        break;
                    }
                }
                transcriptContent.querySelectorAll('.current').forEach(el => el.classList.remove('current'));
                if (currentSpan) {
                    currentSpan.classList.add('current');
                }
            }
            playPauseBtn.addEventListener('click', () => {
                if (video.paused) video.play();
                else video.pause();
            });
            updateVideoTime(); // Initial setup


            const explanationStepsContent = [
                "Step 1: Identify the basic shapes and conditions. Since the problem states DE || BC, we should immediately think of similar triangles.",
                "Step 2: Establish similarity. Because DE || BC, by the corresponding angles postulate, we have ∠ADE = ∠ABC and ∠AED = ∠ACB. Therefore, △ADE ~ △ABC (AA similarity).",
                "Step 3: Set up the proportion equation. The corresponding sides of similar triangles are proportional. So, AD/AB = AE/AC.",
                "Step 4: Substitute the known values. We have AD=3, AB=AD+DB=8, and AE=4. So, 3/8 = 4/AC.",
                "Step 5: Solve for the final answer. Cross-multiplying gives AC = 32/3. Therefore, EC = AC - AE = 32/3 - 4 = 20/3. Problem solved!"
            ];
            let currentExplanationStep = 0;
            const explanationStepsContainer = document.getElementById('explanation-steps');
            const nextStepBtn = document.getElementById('next-step-btn');
            
            nextStepBtn.addEventListener('click', () => {
                if (currentExplanationStep < explanationStepsContent.length) {
                    const stepPara = document.createElement('p');
                    stepPara.textContent = explanationStepsContent[currentExplanationStep];
                    explanationStepsContainer.appendChild(stepPara);
                    currentExplanationStep++;
                }
                if (currentExplanationStep >= explanationStepsContent.length) {
                    nextStepBtn.style.display = 'none';
                }
            });

            const optionsContainer = document.getElementById('answer-options');
            const explanationDiv = document.getElementById('explanation');
            const aiGuidanceContainer = document.getElementById('ai-guidance-container');
            const staticExplanationContainer = document.getElementById('static-explanation-container');
            const aiGuidanceChat = document.getElementById('ai-guidance-chat');
            const guidanceInput = document.getElementById('guidance-input');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            let guidanceConversationHistory = [];

            async function startAiGuidance(wrongAnswer) {
                explanationDiv.style.display = 'block';
                aiGuidanceContainer.style.display = 'block';
                staticExplanationContainer.style.display = 'none';
                
                const questionText = document.getElementById('question-text').textContent.trim();
                const prompt = `You are a patient math tutor who uses the Socratic method. A student just answered the following question incorrectly. Your task is to guide them to the correct answer with questions, without giving the answer away.
                
                Question: "${questionText}"
                Student's incorrect answer: "${wrongAnswer}"

                Now, provide your first guiding question to help the student start thinking.`;

                guidanceConversationHistory = [{role: 'user', parts: [{text: prompt}]}];
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'chat-msg ai-msg loading-msg';
                loadingDiv.textContent = 'Tutor is thinking...';
                aiGuidanceChat.innerHTML = '';
                aiGuidanceChat.appendChild(loadingDiv);

                const firstGuidance = await callGeminiApi(prompt);
                
                loadingDiv.textContent = firstGuidance;
                loadingDiv.classList.remove('loading-msg');
                guidanceConversationHistory.push({role: 'model', parts: [{text: firstGuidance}]});
            }
            
            guidanceInput.addEventListener('keyup', async (event) => {
                if (event.key === 'Enter' && guidanceInput.value.trim() !== '') {
                    const userReply = guidanceInput.value.trim();
                    guidanceInput.value = '';

                    const userMsgDiv = document.createElement('div');
                    userMsgDiv.className = 'chat-msg user-msg';
                    userMsgDiv.textContent = userReply;
                    aiGuidanceChat.appendChild(userMsgDiv);
                    
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'chat-msg ai-msg loading-msg';
                    loadingDiv.textContent = '...';
                    aiGuidanceChat.appendChild(loadingDiv);
                    aiGuidanceChat.scrollTop = aiGuidanceChat.scrollHeight;

                    guidanceConversationHistory.push({role: 'user', parts: [{text: userReply}]});
                    
                    const prompt = `This is the conversation history so far: ${JSON.stringify(guidanceConversationHistory)}. Based on the student's latest reply, continue with the next guiding question. Remember, do not give direct answers; inspire them to think.`;
                    
                    const nextGuidance = await callGeminiApi(prompt);
                    
                    loadingDiv.textContent = nextGuidance;
                    loadingDiv.classList.remove('loading-msg');
                    guidanceConversationHistory.push({role: 'model', parts: [{text: nextGuidance}]});
                    aiGuidanceChat.scrollTop = aiGuidanceChat.scrollHeight;
                }
            });

            showAnswerBtn.addEventListener('click', () => {
                aiGuidanceContainer.style.display = 'none';
                staticExplanationContainer.style.display = 'block';
                explanationStepsContainer.innerHTML = '';
                explanationStepsContent.forEach(step => {
                    const p = document.createElement('p');
                    p.textContent = step;
                    explanationStepsContainer.appendChild(p);
                });
                nextStepBtn.style.display = 'none';
            });

            if (optionsContainer) {
                optionsContainer.addEventListener('click', (event) => {
                    const clickedButton = event.target.closest('.option-btn');
                    if (!clickedButton || clickedButton.classList.contains('disabled')) return;
                    
                    const isCorrect = clickedButton.getAttribute('data-correct') === 'true';
                    const allButtons = optionsContainer.querySelectorAll('.option-btn');
                    
                    allButtons.forEach(btn => btn.classList.add('disabled'));
                    
                    if (isCorrect) {
                        clickedButton.classList.add('correct');
                        explanationDiv.style.display = 'block';
                        aiGuidanceContainer.style.display = 'none';
                        staticExplanationContainer.style.display = 'block';
                        explanationStepsContainer.innerHTML = '';
                        currentExplanationStep = 0;
                        nextStepBtn.style.display = 'inline-block';
                        nextStepBtn.disabled = false;
                    } else {
                        clickedButton.classList.add('incorrect');
                        const correctButton = optionsContainer.querySelector('.option-btn[data-correct="true"]');
                        if (correctButton) correctButton.classList.add('correct');
                        
                        const wrongAnswerText = clickedButton.querySelector('.option-text').textContent;
                        startAiGuidance(wrongAnswerText);
                    }
                });
            }

            const aiAssistBtn = document.getElementById('ai-assist-btn');
            const conversationChatBody = document.getElementById('conversation-chat-body');
            const conversationChatInput = document.getElementById('conversation-chat-input');
            const sendConversationBtn = document.getElementById('send-conversation-btn');
            let currentConversationEntry = null;

            // Add initial Tutor message
            if (conversationChatBody) {
                const initialAiMsg = document.createElement('div');
                initialAiMsg.className = 'chat-msg ai-msg';
                initialAiMsg.textContent = "Hello! I'm your Tutor for this lesson. Feel free to ask me anything about similar triangles!";
                conversationChatBody.appendChild(initialAiMsg);
            }
            
            aiAssistBtn.addEventListener('click', () => {
                openAuxiliaryTab({ currentTarget: document.querySelector('.auxiliary-tab-button[onclick*="conversations"]') }, 'conversations');
                conversationChatInput.focus();
                video.pause();
            });
            
            document.addEventListener('resetConversation', () => {
                currentConversationEntry = null;
            });
            
            const handleSendMessage = async () => {
                const userMessage = conversationChatInput.value.trim();
                if (userMessage === '') return;
                
                conversationChatInput.value = '';

                if (!currentConversationEntry) {
                    const conversationContainer = document.getElementById('conversation-chat-container');
                    currentConversationEntry = document.createElement('div');
                    currentConversationEntry.className = 'conversation-entry';
                    
                    const now = new Date();
                    const timestamp = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
                    
                    currentConversationEntry.innerHTML = `
                        <span class="conversation-timestamp">Conversation with AI ${timestamp}</span>
                        <div class="conversation-context">Context: At video time ${formatTime(video.currentTime)}, regarding "${video.getCurrentTopic()}".</div>
                        <div class="conversation-body chat-body"></div>
                    `;
                    conversationContainer.prepend(currentConversationEntry);
                }
                
                const convBody = currentConversationEntry.querySelector('.conversation-body');

                const userMsgDiv = document.createElement('div');
                userMsgDiv.className = 'chat-msg user-msg';
                userMsgDiv.textContent = userMessage;
                convBody.appendChild(userMsgDiv);

                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'chat-msg ai-msg loading-msg';
                loadingDiv.textContent = 'AI Assistant is thinking...';
                convBody.appendChild(loadingDiv);
                convBody.scrollTop = convBody.scrollHeight;

                const systemPrompt = `You are a friendly and professional AI math tutor. A student is watching a video about '${video.getCurrentTopic()}' and has a question at time ${formatTime(video.currentTime)}. Please answer clearly and concisely.`;
                const fullPrompt = `${systemPrompt}\n\nStudent's question: ${userMessage}`;
                
                const aiResponse = await callGeminiApi(fullPrompt);

                loadingDiv.textContent = aiResponse;
                loadingDiv.classList.remove('loading-msg');
                convBody.scrollTop = convBody.scrollHeight;
            };

            conversationChatInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    handleSendMessage();
                }
            });
            sendConversationBtn.addEventListener('click', handleSendMessage);
            
            const saveNoteBtn = document.getElementById('save-note-btn');
            const notesListContainer = document.getElementById('notes-list-container');
            const submitNoteBtn = document.getElementById('submit-note-btn');
            const noteInput = document.getElementById('note-input');
            
            function createNoteEntry(content, type = 'manual') {
                const newNoteEntry = document.createElement('div');
                newNoteEntry.className = 'note-entry';
                
                let innerHTML = '';

                if (type === 'keyframe') {
                    innerHTML = `
                        <div class="note-thumbnail">Keyframe</div>
                        <div class="note-content">
                            <span class="note-timestamp">Video Time: ${content.videoTime}</span>
                            <div class="note-transcript-quote" contenteditable="true">"${content.transcript}"</div>
                        </div>
                    `;
                } else { // manual
                    newNoteEntry.classList.add('manual-note');
                    const now = new Date();
                    const logTime = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
                    innerHTML = `
                        <span class="note-timestamp">${logTime}</span>
                        <div class="note-body" contenteditable="true">${content.replace(/\n/g, '<br>')}</div>
                    `;
                }
                
                newNoteEntry.innerHTML = innerHTML;
                notesListContainer.prepend(newNoteEntry);
            }

            saveNoteBtn.addEventListener('click', () => {
                const currentTranscriptLine = document.querySelector('.transcription-pane .content .current')?.parentElement.textContent.trim() || "No transcript available at this time.";
                
                const noteContent = {
                    videoTime: formatTime(video.currentTime),
                    transcript: currentTranscriptLine
                };

                createNoteEntry(noteContent, 'keyframe');
                
                // Switch to notes tab to show the user
                openAuxiliaryTab({ currentTarget: document.querySelector('.auxiliary-tab-button[onclick*="notes"]') }, 'notes');

                // Show a brief notification
                const notification = document.createElement('div');
                notification.textContent = 'Keyframe note saved!';
                notification.style.cssText = `position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background-color: var(--primary-color); color: white; padding: 10px 20px; border-radius: 8px; box-shadow: var(--shadow); z-index: 2000;`;
                document.body.appendChild(notification);
                setTimeout(() => { document.body.removeChild(notification); }, 2000);
            });

            const handleAddNote = () => {
                const noteText = noteInput.value.trim();
                if (noteText) {
                    createNoteEntry(noteText, 'manual');
                    noteInput.value = '';
                }
            };

            submitNoteBtn.addEventListener('click', handleAddNote);
            noteInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    handleAddNote();
                }
            });


            const resizerV = document.getElementById('resizer-v');
            const resizerH = document.getElementById('resizer-h');
            const leftContainer = document.getElementById('left-container');
            const auxSection = document.getElementById('auxiliary-section');
            const videoSection = document.getElementById('video-section');
            const interactiveSectionEl = document.getElementById('interactive-section');

            resizerV.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.addEventListener('mousemove', resizeV);
                document.addEventListener('mouseup', stopResizeV);
            });

            function resizeV(e) {
                const totalWidth = document.body.clientWidth;
                const leftWidth = e.clientX;
                const rightWidth = totalWidth - e.clientX - resizerV.offsetWidth;
                if (leftWidth > 200 && rightWidth > 250) {
                    leftContainer.style.flexBasis = `${leftWidth}px`;
                    auxSection.style.flexBasis = `${rightWidth}px`;
                }
            }
            function stopResizeV() {
                document.removeEventListener('mousemove', resizeV);
            }

            resizerH.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.addEventListener('mousemove', resizeH);
                document.addEventListener('mouseup', stopResizeH);
            });

            function resizeH(e) {
                const containerTop = leftContainer.getBoundingClientRect().top;
                const topHeight = e.clientY - containerTop;
                const bottomHeight = leftContainer.clientHeight - topHeight - resizerH.offsetHeight;
                if (topHeight > 150 && bottomHeight > 200) {
                    videoSection.style.flex = `0 1 ${topHeight}px`;
                    interactiveSectionEl.style.flex = `0 1 ${bottomHeight}px`;
                }
            }
            function stopResizeH() {
                document.removeEventListener('mousemove', resizeH);
            }
        });

        function openInteractiveTab(evt, tabName) {
            const tabcontent = document.querySelectorAll(".interactive-section .interactive-tab-pane");
            tabcontent.forEach(tc => tc.classList.remove('active'));
            const tablinks = document.querySelectorAll(".interactive-section .interactive-tab-button");
            tablinks.forEach(tl => tl.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function openAuxiliaryTab(evt, tabName) {
            if (tabName !== 'conversations') {
                 document.dispatchEvent(new CustomEvent('resetConversation'));
            }

            const tabcontent = document.querySelectorAll(".auxiliary-section .auxiliary-tab-pane");
            tabcontent.forEach(tc => tc.classList.remove('active'));
            const tablinks = document.querySelectorAll(".auxiliary-section .auxiliary-tab-button");
            tablinks.forEach(tl => tl.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
